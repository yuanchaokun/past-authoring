<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Past Authoring · 过去自我书写</title>
<style>
:root {
  --bg: #fafaf9;
  --fg: #1c1917;
  --muted: #78716c;
  --border: #e7e5e4;
  --accent: #292524;
  --accent-light: #44403c;
  --surface: #ffffff;
  --progress: #292524;
  --danger: #dc2626;
  --success: #16a34a;
  --radius: 8px;
  --font: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  --font-serif: 'Georgia', 'Noto Serif SC', serif;
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html {
  font-size: 16px;
  scroll-behavior: smooth;
}

body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--fg);
  line-height: 1.7;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* Progress Bar */
.progress-bar {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 3px;
  background: var(--border);
  z-index: 1000;
}

.progress-bar-fill {
  height: 100%;
  background: var(--progress);
  transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
  width: 0%;
}

/* Top Nav */
.top-nav {
  position: fixed;
  top: 3px;
  left: 0;
  right: 0;
  height: 48px;
  background: rgba(250, 250, 249, 0.85);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  z-index: 999;
  border-bottom: 1px solid var(--border);
  font-size: 13px;
}

.top-nav .nav-left {
  display: flex;
  align-items: center;
  gap: 16px;
  color: var(--muted);
}

.top-nav .nav-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.lang-toggle {
  background: none;
  border: 1px solid var(--border);
  padding: 4px 12px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  color: var(--muted);
  transition: all 0.2s;
  font-family: var(--font);
}

.lang-toggle:hover {
  border-color: var(--accent);
  color: var(--fg);
}

.progress-text {
  font-variant-numeric: tabular-nums;
  color: var(--muted);
  font-size: 12px;
}

/* Main Container */
.container {
  max-width: 680px;
  margin: 0 auto;
  padding: 80px 24px 120px;
  min-height: 100vh;
}

/* Sections */
.section {
  display: none;
  animation: fadeIn 0.5s ease;
}

.section.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Typography */
h1 {
  font-family: var(--font-serif);
  font-size: 2rem;
  font-weight: 400;
  letter-spacing: -0.02em;
  margin-bottom: 8px;
  line-height: 1.3;
}

h2 {
  font-family: var(--font-serif);
  font-size: 1.5rem;
  font-weight: 400;
  margin-bottom: 6px;
  line-height: 1.3;
}

h3 {
  font-size: 0.875rem;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  color: var(--muted);
  margin-bottom: 20px;
}

.subtitle {
  color: var(--muted);
  font-size: 0.95rem;
  margin-bottom: 32px;
  line-height: 1.6;
}

.bilingual {
  margin-bottom: 32px;
}

.bilingual .zh {
  display: block;
  margin-bottom: 8px;
  font-size: 0.95rem;
  line-height: 1.7;
}

.bilingual .en {
  display: block;
  font-size: 0.85rem;
  color: var(--muted);
  line-height: 1.6;
  font-style: italic;
}

/* Intro content blocks */
.intro-block {
  margin-bottom: 28px;
  padding-left: 16px;
  border-left: 2px solid var(--border);
}

.intro-block .zh {
  font-size: 0.95rem;
  margin-bottom: 6px;
  line-height: 1.7;
}

.intro-block .en {
  font-size: 0.82rem;
  color: var(--muted);
  line-height: 1.6;
  font-style: italic;
}

/* Form Elements */
.field {
  margin-bottom: 28px;
}

.field-label {
  display: block;
  font-size: 0.875rem;
  font-weight: 500;
  margin-bottom: 8px;
  color: var(--fg);
}

.field-label .en-label {
  font-weight: 400;
  color: var(--muted);
  font-style: italic;
  font-size: 0.8rem;
  display: block;
  margin-top: 2px;
}

.field-hint {
  font-size: 0.8rem;
  color: var(--muted);
  margin-bottom: 8px;
}

input[type="text"],
textarea {
  width: 100%;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px 16px;
  font-family: var(--font);
  font-size: 0.95rem;
  line-height: 1.6;
  background: var(--surface);
  color: var(--fg);
  transition: border-color 0.2s, box-shadow 0.2s;
  resize: vertical;
}

input[type="text"]:focus,
textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(41, 37, 36, 0.08);
}

textarea {
  min-height: 140px;
}

textarea.large {
  min-height: 220px;
}

.word-count {
  text-align: right;
  font-size: 0.75rem;
  color: var(--muted);
  margin-top: 4px;
  font-variant-numeric: tabular-nums;
}

.word-count.over {
  color: var(--danger);
}

/* Buttons */
.btn-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 48px;
  padding-top: 24px;
  border-top: 1px solid var(--border);
}

.btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 10px 24px;
  font-family: var(--font);
  font-size: 0.875rem;
  border-radius: var(--radius);
  cursor: pointer;
  transition: all 0.2s;
  border: none;
  font-weight: 500;
}

.btn-primary {
  background: var(--accent);
  color: #fff;
}

.btn-primary:hover {
  background: var(--accent-light);
}

.btn-secondary {
  background: none;
  color: var(--muted);
  border: 1px solid var(--border);
}

.btn-secondary:hover {
  border-color: var(--accent);
  color: var(--fg);
}

.btn-ghost {
  background: none;
  color: var(--muted);
  padding: 10px 16px;
}

.btn-ghost:hover {
  color: var(--fg);
}

.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

/* Epoch tabs */
.epoch-tabs {
  display: flex;
  gap: 4px;
  margin-bottom: 32px;
  flex-wrap: wrap;
}

.epoch-tab {
  padding: 6px 14px;
  border-radius: 4px;
  font-size: 0.8rem;
  cursor: pointer;
  border: 1px solid var(--border);
  background: var(--surface);
  color: var(--muted);
  transition: all 0.2s;
  font-family: var(--font);
}

.epoch-tab.active {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

.epoch-tab.completed {
  border-color: var(--success);
  color: var(--success);
}

/* Experience card */
.exp-card {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  background: var(--surface);
}

.exp-card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.exp-card-num {
  font-size: 0.75rem;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.exp-remove {
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  font-size: 0.8rem;
  padding: 4px 8px;
  border-radius: 4px;
  font-family: var(--font);
}

.exp-remove:hover {
  color: var(--danger);
  background: rgba(220, 38, 38, 0.05);
}

/* Checkboxes for top-10 selection */
.check-list {
  list-style: none;
}

.check-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 14px 0;
  border-bottom: 1px solid var(--border);
}

.check-item:last-child {
  border-bottom: none;
}

.check-item input[type="checkbox"] {
  margin-top: 3px;
  accent-color: var(--accent);
  width: 16px;
  height: 16px;
  flex-shrink: 0;
}

.check-item label {
  flex: 1;
}

.check-item .check-epoch {
  font-size: 0.75rem;
  color: var(--muted);
  display: block;
}

.check-item .check-title {
  font-size: 0.9rem;
  font-weight: 500;
}

.selection-count {
  font-size: 0.85rem;
  color: var(--muted);
  margin-bottom: 20px;
}

.selection-count .count-num {
  font-weight: 600;
  color: var(--fg);
}

/* Summary Page */
.summary-section {
  margin-bottom: 40px;
}

.summary-epoch {
  margin-bottom: 32px;
}

.summary-epoch-title {
  font-family: var(--font-serif);
  font-size: 1.1rem;
  margin-bottom: 12px;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--border);
}

.summary-exp {
  margin-bottom: 20px;
  padding-left: 16px;
  border-left: 2px solid var(--border);
}

.summary-exp-title {
  font-weight: 500;
  margin-bottom: 4px;
  font-size: 0.9rem;
}

.summary-exp-text {
  font-size: 0.88rem;
  color: var(--muted);
  line-height: 1.7;
  white-space: pre-wrap;
}

.summary-exp-label {
  font-size: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--muted);
  margin-top: 10px;
  margin-bottom: 4px;
}

/* Deep analysis */
.deep-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 24px;
  margin-bottom: 24px;
}

.deep-card-title {
  font-family: var(--font-serif);
  font-size: 1.1rem;
  margin-bottom: 4px;
}

.deep-card-epoch {
  font-size: 0.75rem;
  color: var(--muted);
  margin-bottom: 16px;
}

/* Export buttons */
.export-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  margin-top: 24px;
}

/* Divider */
.divider {
  height: 1px;
  background: var(--border);
  margin: 40px 0;
}

/* Responsive */
@media (max-width: 640px) {
  .container { padding: 72px 16px 100px; }
  h1 { font-size: 1.5rem; }
  h2 { font-size: 1.25rem; }
  .btn-row { flex-direction: column; gap: 12px; }
  .btn-row .btn { width: 100%; justify-content: center; }
  .epoch-tabs { gap: 6px; }
}

/* Auto-save indicator */
.save-indicator {
  position: fixed;
  bottom: 24px;
  right: 24px;
  font-size: 0.75rem;
  color: var(--muted);
  background: var(--surface);
  padding: 6px 12px;
  border-radius: 4px;
  border: 1px solid var(--border);
  opacity: 0;
  transition: opacity 0.3s;
  z-index: 1000;
}

.save-indicator.show {
  opacity: 1;
}

/* Print styles */
@media print {
  .top-nav, .progress-bar, .btn-row, .save-indicator, .export-row { display: none !important; }
  .container { padding: 20px; max-width: 100%; }
  .section { display: block !important; }
  .section:not(#summary-section) { display: none !important; }
  #summary-section { display: block !important; }
}

/* Scrollbar */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--muted); }

/* Total word count in nav */
.total-words {
  font-size: 0.75rem;
  color: var(--muted);
  font-variant-numeric: tabular-nums;
}
</style>
</head>
<body>

<!-- Progress Bar -->
<div class="progress-bar">
  <div class="progress-bar-fill" id="progressFill"></div>
</div>

<!-- Top Nav -->
<div class="top-nav">
  <div class="nav-left">
    <span style="font-weight:500;color:var(--fg);">Past Authoring</span>
    <span class="progress-text" id="progressText">0%</span>
    <span class="total-words" id="totalWordsNav">共 0 字</span>
  </div>
  <div class="nav-right">
    <button class="lang-toggle" id="langToggle" onclick="toggleLang()">EN / 中</button>
  </div>
</div>

<!-- Save Indicator -->
<div class="save-indicator" id="saveIndicator">已自动保存</div>

<div class="container">

  <!-- ==================== SECTION 0: Welcome ==================== -->
  <div class="section active" id="sec-welcome">
    <h3>Past Authoring</h3>
    <h1>过去自我书写</h1>
    <p class="subtitle">回顾你的过去，理解那些塑造了你的经历</p>

    <div class="intro-block">
      <div class="zh">这个练习旨在帮助你通过书写自己的故事来更清晰地认识过去。理解人生中那些定义性的时刻，能够帮助你照亮当下的处境，更容易规划和确定未来的方向。</div>
      <div class="en">This exercise is designed to help you develop a clearer sense of your past by writing your own story. Understanding the defining moments of your life can help illuminate your present situation and make it easier to plan your future direction.</div>
    </div>

    <div class="intro-block">
      <div class="zh">花时间认真书写自己的人，会变得更快乐、更少焦虑和抑郁、身体更健康。他们会变得更有生产力、更有毅力、更投入生活。</div>
      <div class="en">People who spend time writing carefully about themselves become happier, less anxious and depressed, and physically healthier. They become more productive, persistent and engaged in life.</div>
    </div>

    <div class="intro-block">
      <div class="zh">如果你回忆起让你感到羞耻、内疚、愤怒或受伤的记忆，而这些记忆已经超过一年半，那么你的内心还没有平静下来，你仍然承载着过去的重量。</div>
      <div class="en">If you recall memories that make you feel ashamed, guilty, angry, or hurt, and these memories are more than a year and a half old, then your mind is not at peace, and you are still carrying the weight of your past.</div>
    </div>

    <div class="intro-block">
      <div class="zh">写作是一种精密的思考方式。如果你不去思考那些困难的事情，你很可能会犯严重的错误。当你写下对个人重要的事情时，你可以开始识别那些可能伤害你的事件的原因。</div>
      <div class="en">Writing is a sophisticated form of thinking. If you don't think things through, you are likely to make serious mistakes. When you write about personally important matters, you can start to identify the causes of events that might hurt you.</div>
    </div>

    <div class="intro-block">
      <div class="zh">最好在几天内完成这个练习。研究表明，在写作之间进行睡眠和做梦，可以帮助你更深入地参与练习并巩固新的想法。请给自己时间，让自己深入其中。</div>
      <div class="en">It may be best to do this exercise over several days. Research has demonstrated that sleeping and dreaming can help you participate more deeply and consolidate your new ideas. Take your time and let yourself get deeply into the exercise.</div>
    </div>

    <div class="divider"></div>

    <p style="font-size:0.85rem;color:var(--muted);margin-bottom:8px;">流程概览：</p>
    <p style="font-size:0.9rem;line-height:2;">
      ① 划分7个人生时期 → ② 描述每个时期的重要经历 → ③ 分析每个经历的影响 → ④ 选出10个最关键的经历 → ⑤ 深度分析 → ⑥ 综合总结
    </p>

    <div class="btn-row">
      <div></div>
      <button class="btn btn-primary" onclick="goTo('sec-epochs')">开始书写 →</button>
    </div>
  </div>

  <!-- ==================== SECTION 1: Define 7 Epochs ==================== -->
  <div class="section" id="sec-epochs">
    <h3>Step 1 / 6</h3>
    <h1>划分人生时期</h1>
    <div class="bilingual">
      <span class="zh">请将你的人生经历划分为七个时间段。这些时期可长可短，取决于你想写多少。例如，一个时期可以是"小学时代"，另一个可以是"大学第一年"。如果某段时间内有许多重要的经历，那段时间就值得拥有自己的时期。</span>
      <span class="en">Please divide your life experiences into seven time periods or "epochs". These can be as short or as long as you want. If you have many significant experiences from a particular period, that period deserves its own epoch.</span>
    </div>

    <div id="epochFields"></div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo('sec-welcome')">← 返回</button>
      <button class="btn btn-primary" onclick="goToExperiences()">继续 →</button>
    </div>
  </div>

  <!-- ==================== SECTION 2: Experiences per Epoch ==================== -->
  <div class="section" id="sec-experiences">
    <h3>Step 2 / 6</h3>
    <h1>重要经历</h1>
    <div class="bilingual">
      <span class="zh">请详细描述在这个时期发生的重要经历（最多6个）。可以是积极或消极的经历。建议每个时期至少描述4个重要经历。</span>
      <span class="en">Please describe in detail up to six significant experiences from this period. You can describe positive and negative experiences. We recommend describing at least four significant experiences.</span>
    </div>

    <div class="epoch-tabs" id="epochTabs"></div>
    <div id="experienceFields"></div>

    <div style="margin-top:16px;">
      <button class="btn btn-secondary" id="addExpBtn" onclick="addExperience()">+ 添加经历</button>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo('sec-epochs')">← 返回</button>
      <button class="btn btn-primary" onclick="goToAnalysis()">继续分析 →</button>
    </div>
  </div>

  <!-- ==================== SECTION 3: Analysis of each experience ==================== -->
  <div class="section" id="sec-analysis">
    <h3>Step 3 / 6</h3>
    <h1>经历影响分析</h1>
    <div class="bilingual">
      <span class="zh">请分析这些经历如何塑造了你的人生，如何让你成为今天的自己。它们如何改变了你对他人和世界的看法？</span>
      <span class="en">Please outline how each experience has shaped your life and contributed to making you who you are today. How has the experience changed your view of other people? Of the world?</span>
    </div>

    <div class="epoch-tabs" id="analysisTabs"></div>
    <div id="analysisFields"></div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo('sec-experiences')">← 返回</button>
      <button class="btn btn-primary" onclick="goToTop10()">继续 →</button>
    </div>
  </div>

  <!-- ==================== SECTION 4: Select Top 10 ==================== -->
  <div class="section" id="sec-top10">
    <h3>Step 4 / 6</h3>
    <h1>十个最关键的经历</h1>
    <div class="bilingual">
      <span class="zh">从你写下的所有经历中，选出对你人生影响最大的10个。这些经历将接受进一步的深度分析，帮助你理解它们的意义。</span>
      <span class="en">Choose the ten experiences that were most important in shaping your life. Each of these will be subjected to further analysis to help you understand their significance.</span>
    </div>

    <p class="selection-count">已选择 <span class="count-num" id="selectedCount">0</span> / 10</p>

    <ul class="check-list" id="top10List"></ul>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo('sec-analysis')">← 返回</button>
      <button class="btn btn-primary" onclick="goToDeep()">深度分析 →</button>
    </div>
  </div>

  <!-- ==================== SECTION 5: Deep Analysis ==================== -->
  <div class="section" id="sec-deep">
    <h3>Step 5 / 6</h3>
    <h1>深度分析</h1>
    <div class="bilingual">
      <span class="zh">对你选出的每个关键经历进行深度分析：这个经历是如何发生的？它主要是积极还是消极的？有没有人帮助或伤害了你？你在其中扮演了什么角色？有哪些事情你本应做得不同？有没有超出你控制或理解的重要事件？</span>
      <span class="en">How did this experience come about? Was it primarily positive or negative? Were you helped or hurt by other people? What role did you play? Were there things you should have done differently? Were there important occurrences beyond your control or understanding at that time?</span>
    </div>

    <div id="deepFields"></div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo('sec-top10')">← 返回</button>
      <button class="btn btn-primary" onclick="goToSummary()">查看总结 →</button>
    </div>
  </div>

  <!-- ==================== SECTION 6: Summary ==================== -->
  <div class="section" id="sec-summary">
    <h3>完成 · Complete</h3>
    <h1>你的自传</h1>
    <div class="bilingual">
      <span class="zh">恭喜你完成了过去自我书写练习。如果你的过去不再有困扰你的记忆，如果你的故事已经写得足够清晰，能让别人理解——那么你已经从过去中获得了最有价值的信息。</span>
      <span class="en">Congratulations on completing the Past Authoring exercise. People are much healthier and more hopeful if they have truly derived the most relevant information from their past experiences.</span>
    </div>

    <div id="summaryContent"></div>

    <div class="divider"></div>

    <div class="export-row">
      <button class="btn btn-primary" onclick="exportMarkdown()">导出 Markdown</button>
      <button class="btn btn-secondary" onclick="exportJSON()">导出 JSON</button>
      <button class="btn btn-secondary" onclick="window.print()">打印 / PDF</button>
    </div>

    <div class="btn-row">
      <button class="btn btn-ghost" onclick="goTo('sec-deep')">← 返回编辑</button>
      <button class="btn btn-secondary" onclick="clearAll()">清除所有数据</button>
    </div>
  </div>

</div>

<script>
const STORAGE_KEY = 'past-authoring-data';
const TOTAL_STEPS = 6;

let state = loadState();
let currentEpochIdx = 0;
let showEn = true;

function defaultState() {
  return {
    epochs: Array.from({length: 7}, (_, i) => ({
      name: '',
      experiences: [{ title: '', description: '' }]
    })),
    analyses: {},
    top10: [],
    deepAnalyses: {}
  };
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  return defaultState();
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  showSaved();
}

function showSaved() {
  const el = document.getElementById('saveIndicator');
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 1500);
}

function clearAll() {
  if (confirm('确定要清除所有数据吗？此操作不可撤销。')) {
    localStorage.removeItem(STORAGE_KEY);
    state = defaultState();
    goTo('sec-welcome');
  }
}

// Language Toggle
function toggleLang() {
  showEn = !showEn;
  document.querySelectorAll('.en, .en-label').forEach(el => {
    el.style.display = showEn ? '' : 'none';
  });
  document.getElementById('langToggle').textContent = showEn ? 'EN / 中' : '仅中文';
}

// Navigation
function goTo(sectionId) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(sectionId).classList.add('active');
  window.scrollTo({top: 0, behavior: 'smooth'});
  updateProgress(sectionId);
  saveState();
}

function updateProgress(sectionId) {
  const steps = ['sec-welcome','sec-epochs','sec-experiences','sec-analysis','sec-top10','sec-deep','sec-summary'];
  const idx = steps.indexOf(sectionId);
  const pct = Math.round((idx / (steps.length - 1)) * 100);
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('progressText').textContent = pct + '%';
  updateTotalWords();
}

function updateTotalWords() {
  let total = 0;
  state.epochs.forEach((ep, i) => {
    total += countChars(ep.name);
    ep.experiences.forEach((exp, j) => {
      total += countChars(exp.title) + countChars(exp.description);
      const aKey = `${i}-${j}`;
      if (state.analyses[aKey]) total += countChars(state.analyses[aKey]);
    });
  });
  state.top10.forEach(key => {
    if (state.deepAnalyses[key]) total += countChars(state.deepAnalyses[key]);
  });
  document.getElementById('totalWordsNav').textContent = `共 ${total} 字`;
}

function countChars(s) {
  return s ? s.replace(/\s/g, '').length : 0;
}

// ============ EPOCHS ============
function renderEpochs() {
  const container = document.getElementById('epochFields');
  container.innerHTML = '';
  state.epochs.forEach((ep, i) => {
    container.innerHTML += `
      <div class="field">
        <label class="field-label">
          时期 ${i + 1}
          <span class="en-label">Epoch ${i + 1}</span>
        </label>
        <input type="text" value="${escHtml(ep.name)}"
          placeholder="例：童年早期 (0-6岁) / Early childhood"
          oninput="state.epochs[${i}].name=this.value;debounceSave()">
        <div class="word-count">${countChars(ep.name)} 字</div>
      </div>`;
  });
}

// ============ EXPERIENCES ============
function goToExperiences() {
  const empty = state.epochs.filter(e => !e.name.trim());
  if (empty.length > 3) {
    alert('请至少为4个时期命名');
    return;
  }
  currentEpochIdx = 0;
  goTo('sec-experiences');
  renderEpochTabs('epochTabs');
  renderExperiences();
}

function renderEpochTabs(containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  state.epochs.forEach((ep, i) => {
    if (!ep.name.trim()) return;
    const cls = i === currentEpochIdx ? 'epoch-tab active' : 'epoch-tab';
    container.innerHTML += `<button class="${cls}" onclick="switchEpoch(${i},'${containerId}')">${ep.name || '时期' + (i+1)}</button>`;
  });
}

function switchEpoch(idx, context) {
  saveCurrentFields();
  currentEpochIdx = idx;
  if (context === 'epochTabs') {
    renderEpochTabs('epochTabs');
    renderExperiences();
  } else if (context === 'analysisTabs') {
    renderEpochTabs2('analysisTabs');
    renderAnalysisFields();
  }
}

function renderExperiences() {
  const ep = state.epochs[currentEpochIdx];
  const container = document.getElementById('experienceFields');
  container.innerHTML = '';
  ep.experiences.forEach((exp, j) => {
    container.innerHTML += `
      <div class="exp-card">
        <div class="exp-card-header">
          <span class="exp-card-num">经历 ${j + 1} / Experience ${j + 1}</span>
          ${ep.experiences.length > 1 ? `<button class="exp-remove" onclick="removeExperience(${j})">移除</button>` : ''}
        </div>
        <div class="field">
          <label class="field-label">标题 <span class="en-label">Title</span></label>
          <input type="text" value="${escHtml(exp.title)}"
            placeholder="为这段经历起一个标题"
            oninput="state.epochs[${currentEpochIdx}].experiences[${j}].title=this.value;debounceSave()">
        </div>
        <div class="field">
          <label class="field-label">描述 <span class="en-label">Description (approx. 1000 characters)</span></label>
          <textarea class="large"
            placeholder="详细描述这段经历发生了什么..."
            oninput="state.epochs[${currentEpochIdx}].experiences[${j}].description=this.value;updateWc(this);debounceSave()">${escHtml(exp.description)}</textarea>
          <div class="word-count">${countChars(exp.description)} / ~1000 字</div>
        </div>
      </div>`;
  });
  const addBtn = document.getElementById('addExpBtn');
  addBtn.style.display = ep.experiences.length >= 6 ? 'none' : '';
}

function addExperience() {
  const ep = state.epochs[currentEpochIdx];
  if (ep.experiences.length >= 6) return;
  ep.experiences.push({ title: '', description: '' });
  renderExperiences();
}

function removeExperience(j) {
  const ep = state.epochs[currentEpochIdx];
  if (ep.experiences.length <= 1) return;
  ep.experiences.splice(j, 1);
  renderExperiences();
  saveState();
}

// ============ ANALYSIS ============
function goToAnalysis() {
  currentEpochIdx = 0;
  goTo('sec-analysis');
  renderEpochTabs2('analysisTabs');
  renderAnalysisFields();
}

function renderEpochTabs2(containerId) {
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  state.epochs.forEach((ep, i) => {
    if (!ep.name.trim()) return;
    const cls = i === currentEpochIdx ? 'epoch-tab active' : 'epoch-tab';
    container.innerHTML += `<button class="${cls}" onclick="switchEpoch(${i},'analysisTabs')">${ep.name || '时期' + (i+1)}</button>`;
  });
}

function renderAnalysisFields() {
  const ep = state.epochs[currentEpochIdx];
  const container = document.getElementById('analysisFields');
  container.innerHTML = '';
  ep.experiences.forEach((exp, j) => {
    if (!exp.title.trim()) return;
    const key = `${currentEpochIdx}-${j}`;
    const val = state.analyses[key] || '';
    container.innerHTML += `
      <div class="deep-card">
        <div class="deep-card-title">${escHtml(exp.title)}</div>
        <div class="deep-card-epoch">${escHtml(ep.name)}</div>
        <div class="field">
          <label class="field-label">
            这段经历如何塑造了你的人生？如何让你成为今天的自己？
            <span class="en-label">How has this experience shaped your life and contributed to making you who you are today? How has it changed your view of other people and the world?</span>
          </label>
          <textarea class="large"
            placeholder="写下你的分析..."
            oninput="state.analyses['${key}']=this.value;updateWc(this);debounceSave()">${escHtml(val)}</textarea>
          <div class="word-count">${countChars(val)} / ~1000 字</div>
        </div>
      </div>`;
  });
  if (!container.innerHTML.trim()) {
    container.innerHTML = '<p style="color:var(--muted);font-size:0.9rem;">这个时期没有已命名的经历。请返回上一步添加。</p>';
  }
}

// ============ TOP 10 ============
function goToTop10() {
  goTo('sec-top10');
  renderTop10List();
}

function renderTop10List() {
  const list = document.getElementById('top10List');
  list.innerHTML = '';
  state.epochs.forEach((ep, i) => {
    if (!ep.name.trim()) return;
    ep.experiences.forEach((exp, j) => {
      if (!exp.title.trim()) return;
      const key = `${i}-${j}`;
      const checked = state.top10.includes(key) ? 'checked' : '';
      list.innerHTML += `
        <li class="check-item">
          <input type="checkbox" id="chk-${key}" ${checked} onchange="toggleTop10('${key}')">
          <label for="chk-${key}">
            <span class="check-epoch">${escHtml(ep.name)}</span>
            <span class="check-title">${escHtml(exp.title)}</span>
          </label>
        </li>`;
    });
  });
  updateTop10Count();
}

function toggleTop10(key) {
  const idx = state.top10.indexOf(key);
  if (idx >= 0) {
    state.top10.splice(idx, 1);
  } else {
    if (state.top10.length >= 10) {
      alert('最多选择10个经历');
      document.getElementById('chk-' + key).checked = false;
      return;
    }
    state.top10.push(key);
  }
  updateTop10Count();
  saveState();
}

function updateTop10Count() {
  document.getElementById('selectedCount').textContent = state.top10.length;
}

// ============ DEEP ANALYSIS ============
function goToDeep() {
  if (state.top10.length === 0) {
    alert('请至少选择一个经历进行深度分析');
    return;
  }
  goTo('sec-deep');
  renderDeepFields();
}

function renderDeepFields() {
  const container = document.getElementById('deepFields');
  container.innerHTML = '';
  state.top10.forEach((key, idx) => {
    const [ei, ej] = key.split('-').map(Number);
    const ep = state.epochs[ei];
    const exp = ep.experiences[ej];
    const val = state.deepAnalyses[key] || '';
    container.innerHTML += `
      <div class="deep-card">
        <div class="deep-card-title">${idx + 1}. ${escHtml(exp.title)}</div>
        <div class="deep-card-epoch">${escHtml(ep.name)}</div>
        <div class="field">
          <label class="field-label">
            深度分析
            <span class="en-label">How did this experience come about? Was it primarily positive or negative? Were you helped or hurt by other people? What role did you play to shape these events? Were there things you should have done differently? Were there important occurrences beyond your control or understanding?</span>
          </label>
          <textarea class="large"
            placeholder="深入分析这段经历..."
            oninput="state.deepAnalyses['${key}']=this.value;updateWc(this);debounceSave()">${escHtml(val)}</textarea>
          <div class="word-count">${countChars(val)} / ~1000 字</div>
        </div>
      </div>`;
  });
}

// ============ SUMMARY ============
function goToSummary() {
  goTo('sec-summary');
  renderSummary();
}

function renderSummary() {
  const container = document.getElementById('summaryContent');
  let html = '';

  state.epochs.forEach((ep, i) => {
    if (!ep.name.trim()) return;
    const hasContent = ep.experiences.some(e => e.title.trim());
    if (!hasContent) return;

    html += `<div class="summary-epoch">`;
    html += `<div class="summary-epoch-title">${escHtml(ep.name)}</div>`;

    ep.experiences.forEach((exp, j) => {
      if (!exp.title.trim()) return;
      const key = `${i}-${j}`;
      html += `<div class="summary-exp">`;
      html += `<div class="summary-exp-title">${escHtml(exp.title)}</div>`;

      if (exp.description.trim()) {
        html += `<div class="summary-exp-label">描述 Description</div>`;
        html += `<div class="summary-exp-text">${escHtml(exp.description)}</div>`;
      }

      if (state.analyses[key]) {
        html += `<div class="summary-exp-label">影响分析 Impact Analysis</div>`;
        html += `<div class="summary-exp-text">${escHtml(state.analyses[key])}</div>`;
      }

      if (state.top10.includes(key) && state.deepAnalyses[key]) {
        html += `<div class="summary-exp-label">★ 深度分析 Deep Analysis</div>`;
        html += `<div class="summary-exp-text">${escHtml(state.deepAnalyses[key])}</div>`;
      }

      html += `</div>`;
    });

    html += `</div>`;
  });

  container.innerHTML = html || '<p style="color:var(--muted);">暂无内容。</p>';
}

// ============ EXPORT ============
function exportMarkdown() {
  let md = '# Past Authoring / 过去自我书写\n\n';
  md += `导出时间: ${new Date().toLocaleString('zh-CN')}\n\n---\n\n`;

  state.epochs.forEach((ep, i) => {
    if (!ep.name.trim()) return;
    md += `## ${ep.name}\n\n`;

    ep.experiences.forEach((exp, j) => {
      if (!exp.title.trim()) return;
      const key = `${i}-${j}`;
      const isTop = state.top10.includes(key);
      md += `### ${isTop ? '★ ' : ''}${exp.title}\n\n`;

      if (exp.description.trim()) {
        md += `**描述 / Description**\n\n${exp.description}\n\n`;
      }
      if (state.analyses[key]) {
        md += `**影响分析 / Impact Analysis**\n\n${state.analyses[key]}\n\n`;
      }
      if (isTop && state.deepAnalyses[key]) {
        md += `**深度分析 / Deep Analysis**\n\n${state.deepAnalyses[key]}\n\n`;
      }
      md += '---\n\n';
    });
  });

  downloadFile('past-authoring.md', md, 'text/markdown');
}

function exportJSON() {
  const json = JSON.stringify(state, null, 2);
  downloadFile('past-authoring.json', json, 'application/json');
}

function downloadFile(name, content, type) {
  const blob = new Blob([content], { type: type + ';charset=utf-8' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ============ UTILS ============
function escHtml(s) {
  if (!s) return '';
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function updateWc(textarea) {
  const wc = textarea.parentElement.querySelector('.word-count');
  if (wc) {
    const count = countChars(textarea.value);
    const max = wc.textContent.includes('/') ? wc.textContent.split('/')[1].trim().replace(/[^0-9]/g, '') : '';
    wc.textContent = max ? `${count} / ~${max} 字` : `${count} 字`;
    wc.classList.toggle('over', max && count > parseInt(max) * 1.5);
  }
  updateTotalWords();
}

let saveTimer;
function debounceSave() {
  clearTimeout(saveTimer);
  saveTimer = setTimeout(() => {
    saveState();
    updateTotalWords();
  }, 800);
}

function saveCurrentFields() {
  // Fields are saved via oninput handlers
}

// ============ INIT ============
function init() {
  renderEpochs();
  updateProgress('sec-welcome');
}

init();
</script>
</body>
</html>
