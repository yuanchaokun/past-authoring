name: Deploy to Cloudflare R2

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get fresh Cloudflare token
        id: token
        run: |
          RESP=$(curl -sf -X POST https://dash.cloudflare.com/oauth2/token \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=refresh_token&refresh_token=${{ secrets.CLOUDFLARE_REFRESH_TOKEN }}&client_id=54d11594-84e4-41aa-b438-e81b8fa78ee7")
          echo "access_token=$(echo $RESP | python3 -c \"import json,sys;print(json.load(sys.stdin)['access_token'])\")" >> $GITHUB_OUTPUT
          echo "refresh_token=$(echo $RESP | python3 -c \"import json,sys;print(json.load(sys.stdin).get('refresh_token',''))\")" >> $GITHUB_OUTPUT

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Upload to R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ steps.token.outputs.access_token }}
          CLOUDFLARE_ACCOUNT_ID: ad79f21230344be2e7a62597f2c20586
        run: |
          for file in *.html; do
            wrangler r2 object put "past-authoring/$file" \
              --file "$file" \
              --content-type "text/html; charset=utf-8" \
              --remote
          done
          echo "âœ… Deployed to https://pub-6bf4ebbe25ee462f852fee7b248afa19.r2.dev"
